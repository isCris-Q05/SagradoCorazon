<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visualización</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
    <link rel="stylesheet" href="{% static 'css/inicio.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- En el head de tu HTML -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Al final del body, antes de tu script.js -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js'></script>
    <script src="tu_script.js"></script> <!-- Tu archivo JS con el código del calendario -->
    
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      defer
    ></script>


  </head>

  <body>
    <main class="main-body">
      <div class="sidebar">
        <div class="logo">🏥 DermaCare</div>
        <nav>
            <a href="{% url 'inicio' %}" class="nav-item">Inicio</a>
            <a href="{% url 'doctores' %}" class="nav-item">Doctores</a>
            <a href="{% url 'registrar_pacientes' %}" class="nav-item">Pacientes</a>
            <a href="{% url 'productos' %}" class="nav-item">Productos</a>
            <a href="{% url 'enfermedades_alergias' %}" class="nav-item">Alergias y Enfermedades</a>
            <a href="{% url 'tratamientos' %}" class="nav-item">Tratamientos</a>
            <a href="{% url 'visualizacion' %}"  class="nav-item active">Visualización</a>
          </nav>
      </div>
      <div class="main-content">
        <div class="top-bar">
          <h2>Visualización</h2>
          <div class="icons">
            <span class="user-name" style="font-weight: bold"
              >{{ user.username }}</span
            >
            <a href="{% url 'logout' %}" class="logout-link">Cerrar sesión</a>
          </div>
        </div>
        <div class="header">
          <input type="text" placeholder="Buscar cita..." class="search-bar" />
          <button
            class="btn btn-primary"
            id="crearCitaBtn"
            data-bs-toggle="modal"
            data-bs-target="#crearCitaModal"
          >
            Crear Cita
          </button>
          <button
            class="btn btn-primary"
            id="crearRegistroBtn"
            data-bs-toggle="modal"
            data-bs-target="#crearRegistroModal"
          >
            Agregar Registro
          </button>

          <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" id="filtrosBtn" type="button" 
                    data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-funnel-fill me-1"></i> Filtros
            </button>
            <ul class="dropdown-menu p-3">
              <li><h6 class="dropdown-header">Filtrar por estado de cita:</h6></li>
              <li>
                <label class="dropdown-item">
                  <input type="radio" name="estadoCita" class="form-check-input me-2" 
                        value="pendientes" onchange="filtrarCitas(this.value)">
                  Pendientes
                </label>
              </li>
              <li>
                <label class="dropdown-item">
                  <input type="radio" name="estadoCita" class="form-check-input me-2" 
                        value="finalizadas" onchange="filtrarCitas(this.value)">
                  Finalizadas
                </label>
              </li>
              <li>
                <label class="dropdown-item">
                  <input type="radio" name="estadoCita" class="form-check-input me-2" 
                        value="no_asistio" onchange="filtrarCitas(this.value)">
                  No asistió
                </label>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <button class="btn btn-sm btn-outline-danger w-100" onclick="limpiarFiltros()">
                  Limpiar filtros
                </button>
              </li>
            </ul>
          </div>

          <!-- Contador "Total" -->
          <div class="total-counter bg-light border rounded p-2">
            <span class="fw-bold">Total:</span>
            <span id="contadorTotal" class="fs-4 ms-2">{{ cantidad_citas }}</span> <!-- El valor inicial se actualizará -->
          </div>

        </div>

        <div class="header d-flex justify-content-between">
            <!-- Botones para visualizacion de datos
             1. Pacientes
             2. Enfermedades
             3. Tratamientos
            -->
          <div class="left-buttons">
              <button class="btn btn-info" id="mostrarCitasBtn">
                  <i class="fas fa-calendar-day"></i> Mostrar Citas
              </button>
                <button class="btn btn-info" id="mostrarEnfermedadesBtn">
                    <i class="fas fa-notes-medical"></i> Mostrar Enfermedades
                </button>
                <button class="btn btn-info" id="mostrarTratamientosBtn">
                    <i class="fas fa-prescription-bottle-alt"></i> Mostrar Tratamientos
                </button>
          </div>
          <div class="right-buttons d-flex align-items-center gap-2">  <!-- Añadido gap-2 para separación controlada -->
            <form action="{% url 'generar_reporte' %}" method="get" id="exportForm" class="m-0">  <!-- m-0 para eliminar márgenes -->
                <button class="btn btn-success" id="generarReporteBtn">
                    <i class="fas fa-file-excel"></i> Generar Reporte
                </button>
            </form>
            <!--<button  type="submit" ="btn btn-primary" id="subirReporteBtn">
                <i class="fas fa-upload"></i> Subir Reporte
            </button>-->
            <!-- Formulario de subida (en tu index.html existente) -->
            <form id="excelUploadForm" method="post" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="form-group">
                  {{ form.excel_file.label_tag }}
                  {{ form.excel_file }}
              </div>
              <button type="submit" id="subirReporteBtn" class="btn btn-primary">
                  <i class="fas fa-upload"></i> Subir Excel
              </button>
            </form>
          </div>
        </div>

        <!-- Nuevos botones para vista tabla/calendario (ocultos inicialmente) -->
        <div id="vistaToggleContainer" class="btn-group ms-3" role="group" style="display: none;">
          <button id="vistaTablaBtn" class="btn btn-success active">
            <i class="fas fa-table"></i> Tabla
          </button>
          <button id="vistaCalendarioBtn" class="btn btn-outline-success">
            <i class="fas fa-calendar-alt"></i> Calendario
          </button>
        </div>


        {% if messages %}
            <div class="container mt-3">
              {% for message in messages %}
                {% if message.tags == 'error' %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {% elif message.tags == 'warning' %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                {% else %}
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                {% endif %}
                  <strong>{{ message }}</strong>
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            </div>
        {% endif %}

      <!-- Contenedor principal -->
       <div id="contenedorPrincipal">
          <!-- Tabla de citas -->

         <div id="tablaCitas">
           <table class="table">
             <thead>
               <tr>
                 <th>Código de cita</th>
                 <th>Nombre completo</th>
                 <th>Estado</th>
                 <th>Fecha</th>
                 <th>Hora inicio</th>
                 <th>Doctor asignado</th>
                 <th>Notificado</th>
               </tr>
             </thead>
             <tbody>
               {% for cita in citas %}
               <tr>
                 <td>{{ cita.id_cita }}</td>
                 <td>{{ cita.id_paciente }}</td>
                 <td>
                   {% if cita.estado == 'pendiente' %}
                   <span class="badge bg-warning">Pendiente</span>
                   {% elif cita.estado == 'finalizada' %}
                   <span class="badge bg-success">Finalizada</span>
                   {% elif cita.estado == 'no_asistio' %}
                   <span class="badge bg-danger">No asistió</span>
                   {% endif %}
                 </td>
                 <td>{{ cita.fecha }}</td>
                 <td>{{ cita.hora }}</td>
                 <td>{{ cita.id_medico }}</td>
                 <td>
                   <!--
                   {{ cita.id_paciente.telefono }}
                   -->
                   <input class="form-check-input" type="checkbox" name="doctor" id="doctor2" value="2">
                   
                 </td>
                 <td>
                   <button
                     class="btn btn-outline-success btn-sm"
                     data-bs-toggle="modal"
                     data-bs-target="#editCitaModal"
                     data-id="{{ cita.id_cita }}"
                     data-paciente="{{ cita.id_paciente }}"
                     data-estado="{{ cita.estado }}"
                     data-fecha="{{ cita.fecha | date:'Y-m-d' }}"
                     data-hora="{{ cita.hora | time:'H:i' }}"
                     data-medico="{{ cita.id_medico }}"
                     data-telefono=" {{ cita.id_paciente.telefono }} "
                   >
                     Editar
                   </button>
                 </td>
                 <td>
               </tr>
               {% endfor %}
             </tbody>
           </table>
         </div>

          <!-- Calendario de citas -->
          <div id="calendarioCitas" class="view-content hidden">
            <div id="calendar"></div>
          </div>
         
          <!-- Tabla de registros -->
          <div id="tablaRegistros" class="hidden">
            <table class="table">
              <thead>
                <tr>
                  <th>Código de registro</th>
                  <th>Código de cita</th>
                  <th>Motivo</th>
                  <th>Observaciones</th>
                  <th>Enfermedad</th>
                  <th>Tratamientos</th>
                  <th>Productos</th>
                  <th>Asistencia</th>
                </tr>
              </thead>
              <tbody>
                {% for registro in registros %}
                <tr>
                  <td>{{ registro.id_registro }}</td>
                  <td>{{ registro.id_cita.id_cita }}</td>
                  <td>{{ registro.motivo }}</td>
                  <td>{{ registro.observaciones }}</td>
                  <td>{{ registro.id_enfermedad.nombre }}</td>
                  <td>
                    {% for tratamiento in registro.tratamientos.all %}
                    <span class="badge bg-info"
                      >{{ tratamiento.id_tratamiento.nombre }}</span
                    >
                    {% endfor %}
                  </td>
                  <td>
                    {% for producto in registro.registroproducto_set.all %}
                    <span class="badge bg-warning"
                      >{{ producto.id_producto.nombre }}</span
                    >
                    {% endfor %}
                  </td>
                  <td>
                    {% if registro.id_cita.estado == 'finalizada' %}
                    <span class="badge bg-success">Asitió</span>
                    {% else %}
                    <span class="badge bg-danger">No asistió</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

       </div>


        <div id="paginadorContainer">
          <!-- Paginador estático inicial -->
          <div class="d-flex justify-content-between align-items-center mt-3" id="paginadorEstatico">
            {% if citas.has_previous %}
            <a href="?page={{ citas.previous_page_number }}" class="btn btn-primary btn-next-prev">
              &laquo; Anterior
            </a>
            {% else %}
            <span class="btn btn-secondary btn-next-prev disabled">&laquo; Anterior</span>
            {% endif %}

            <span>Página {{ citas.number }} de {{ citas.paginator.num_pages }}</span>

            {% if citas.has_next %}
            <a href="?page={{ citas.next_page_number }}" class="btn btn-primary btn-next-prev">
              Siguiente &raquo;
            </a>
            {% else %}
            <span class="btn btn-secondary btn-next-prev disabled">Siguiente &raquo;</span>
            {% endif %}
          </div>
          <!-- Final del paginador estático -->
        </div>

        <!-- Contenedor del calendario -->
        <div id="calendarioContainer" class="hidden">
          <div id="calendar"></div>
        </div>
      </div>

      <!-- Barra de notificaciones -->
      <div
        id="notificationBar"
        class="card shadow-sm p-3 mb-5 bg-body-tertiary"
        style="
          display: none;
          position: absolute;
          top: 50px;
          right: 20px;
          width: 300px;
          z-index: 1050;
        "
      >
        <h5 class="card-title">Notificaciones</h5>
        <div class="card-text">
          {% for notificacion in notificaciones %}
          <p><strong>Paciente:</strong> {{ notificacion.paciente }}</p>
          <p><strong>Fecha:</strong> {{ notificacion.fecha }}</p>
          <p><strong>Hora:</strong> {{ notificacion.hora }}</p>
          <hr />
          {% endfor %}
        </div>
        <button class="btn btn-primary btn-sm w-100" id="clearNotifications">
          Cerrar
        </button>
      </div>

      <!-- Modal para mostrar Usuario -->
      <div
        class="modal fade"
        id="userModal"
        tabindex="-1"
        aria-labelledby="userModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="userModalLabel">
                Información del Usuario
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body text-center">
              <img
                src="{% static 'imagenes/usser.png' %}"
                alt="Foto de Usuario"
                class="img-fluid rounded-circle mb-3"
                style="width: 100px; height: 100px"
              />
              <h5 class="mb-3">{{ user.nombre }}</h5>
              <button
                type="button"
                id="cerrarSesionbtn"
                class="btn btn-danger w-100"
              >
                Cerrar Sesión
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal para editar cita -->
      <div
        class="modal fade"
        id="editCitaModal"
        tabindex="-1"
        aria-labelledby="editCitaModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editCitaModalLabel">Editar Cita</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <form id="editCitaForm" method="POST" action="{% url 'editar_cita' %}">
                {% csrf_token %}
                <input type="hidden" name="id_cita" id="editIdCita" />
                <input type="hidden" id="editTelefono" />  <!-- Campo oculto para el teléfono -->
                <div class="mb-3">
                  <label for="editPaciente" class="form-label">Paciente</label>
                  <input
                    type="text"
                    class="form-control"
                    id="editPaciente"
                    name="paciente"
                    readonly
                  />
                </div>
                <div class="mb-3">
                  <label for="editEstado" class="form-label">Estado</label>
                  <select class="form-select" id="editEstado" name="estado">
                    <option value="pendiente">Pendiente</option>
                    <option value="finalizada">Finalizada</option>
                    <option value="no_asistio">No asistió</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="editFecha" class="form-label">Fecha</label>
                  <input
                    type="date"
                    class="form-control"
                    id="editFecha"
                    name="fecha"
                  />
                </div>
                <div class="mb-3">
                  <label for="editHora" class="form-label">Hora</label>
                  <input
                    type="time"
                    class="form-control"
                    id="editHora"
                    name="hora"
                  />
                </div>
                <div class="mb-3">
                  <label for="editMedico" class="form-label">Médico</label>
                  <input
                    type="text"
                    class="form-control"
                    id="editMedico"
                    name="medico"
                    readonly
                  />
                </div>
                <div class="mb-3">
                  <label for="editMedico" class="form-label">Enviar recordatorio</label>
                  <button type="button" class="btn btn-secondary" id="sendNotification">Enviar</button>
                </div>

                <button type="submit" class="btn btn-primary">
                  Guardar cambios
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

    </main>

    <!-- Alerta personalizada -->
    <div id="customAlert" class="custom-alert">
      <div class="alert-content">
        <div class="alert-icon">
          <svg viewBox="0 0 24 24">
            <path fill="currentColor" d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M10,17l-5-5l1.41-1.41L10,14.17l7.59-7.59L19,8l-9,9z"/>
          </svg>
        </div>
        <h3>¡Reporte subido con éxito!</h3>
        <p>El archivo se ha cargado correctamente al sistema.</p>
        <button id="closeAlert" class="alert-btn">Aceptar</button>
      </div>
    </div>

    <script src="{% static 'js/notificaciones.js' %}"></script>
    <script src="{% static 'js/busqueda.js' %}"></script>
    <script src="{% static 'js/buscarCita.js' %}"></script>
    <script src="{% static 'js/tratamientoEnf.js' %}"></script>
    <!--optionShow.js-->
    <script src="{% static 'js/optionShow.js' %}"></script>
    <script src="{% static 'js/alertCustom.js' %}"></script>
    <script src="{% static 'js/cargarNombrePaciente.js' %}"></script>
    <script src="{% static 'js/validarHoraCitas.js' %}"></script>
    <script src="{% static 'js/filtrarCitas.js' %}"></script>
    <!--
      <script src="{% static 'js/sendReminder.js' %}"></script>
    -->
  </body>

  <script>
  window.pacienteNombre = "{{ paciente_nombre|escapejs }}";

  document.addEventListener('DOMContentLoaded', function () {
    const idMedicoInput = document.getElementById("id_medico");
    const fechaInput = document.getElementById("fechaCita");
    const horaInput = document.getElementById("horaInicioCita");
    const form = document.querySelector('#crearCitaModal form');
    const errorSpan = document.getElementById("error-disponibilidad");
    const submitBtn = document.getElementById("btn-guardar-cita");

    async function validarDisponibilidad() {
      const id_medico = idMedicoInput.value;
      const fecha = fechaInput.value;
      const hora = horaInput.value;

      if (!id_medico || !fecha || !hora) {
        errorSpan.textContent = "";
        submitBtn.disabled = true;
        return false;
      }

      try {
        const response = await fetch(`/validar-disponibilidad/?id_medico=${id_medico}&fecha=${fecha}&hora=${hora}`);
        const data = await response.json();

        if (!data.disponible) {
          errorSpan.textContent = data.mensaje;
          submitBtn.disabled = true;
          return false;
        } else {
          errorSpan.textContent = "";
          submitBtn.disabled = false;
          return true;
        }
      } catch (error) {
        console.error("Error en la validación de disponibilidad:", error);
        errorSpan.textContent = "Error al validar la disponibilidad.";
        submitBtn.disabled = true;
        return false;
      }
    }

    // Validar cada vez que cambien los campos
    idMedicoInput.addEventListener("change", validarDisponibilidad);
    fechaInput.addEventListener("change", validarDisponibilidad);
    horaInput.addEventListener("change", validarDisponibilidad);

    // Evita enviar el formulario si hay conflicto
    form.addEventListener("submit", async function (e) {
      const disponible = await validarDisponibilidad();
      if (!disponible) {
        e.preventDefault();
      }
    });
  });
</script>

    window.pacienteNombre = "{{ paciente_nombre|escapejs }}";
  </script>

</html>
